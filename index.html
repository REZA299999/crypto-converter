<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CryptoXchanger - Konversi Crypto Real-Time (Debug)</title>
  <meta name="description" content="Konversi cryptocurrency populer secara real-time tanpa API key." />
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    h1 { color: #00f7c4; }
    select, input {
      padding: 10px;
      margin: 10px;
      background-color: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 5px;
    }
    img.icon {
      width: 24px;
      vertical-align: middle;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <h1>ðŸ’± <span style="color: #00f7c4">CryptoXchanger Debug</span></h1>
  <p>Konversi crypto populer secara real-time tanpa API key</p>

  <div>
    <label>Dari:<br>
      <img id="iconFrom" class="icon" src="" alt="icon" />
      <select id="fromCurrency"></select>
    </label>
  </div>

  <div>
    <label>Ke:<br>
      <img id="iconTo" class="icon" src="" alt="icon" />
      <select id="toCurrency"></select>
    </label>
  </div>

  <div>
    <label>Jumlah:<br>
      <input type="number" id="amount" value="1" min="0" step="any" />
    </label>
  </div>

  <h2 id="result">Masukkan jumlah untuk melihat hasil...</h2>

  <script>
    const supportedCoins = [
      { symbol: "BTC", id: "bitcoin", icon: "bitcoin" },
      { symbol: "ETH", id: "ethereum", icon: "ethereum" },
      { symbol: "LTC", id: "litecoin", icon: "litecoin" },
      { symbol: "SOL", id: "solana", icon: "solana" },
      { symbol: "USDT", id: "tether", icon: "tether" },
      { symbol: "BNB", id: "binancecoin", icon: "binancecoin" },
      { symbol: "MATIC", id: "polygon", icon: "polygon" },
      { symbol: "ARB", id: "arbitrum", icon: "arbitrum" },
      { symbol: "OP", id: "optimism", icon: "optimism" }
      // Hapus BASE karena kemungkinan tidak tersedia di CoinGecko
    ];

    const fromSelect = document.getElementById("fromCurrency");
    const toSelect = document.getElementById("toCurrency");
    const iconFrom = document.getElementById("iconFrom");
    const iconTo = document.getElementById("iconTo");
    const amountInput = document.getElementById("amount");
    const resultText = document.getElementById("result");

    function populateSelects() {
      supportedCoins.forEach(({ symbol }) => {
        const optionFrom = document.createElement("option");
        optionFrom.value = symbol;
        optionFrom.textContent = symbol;
        fromSelect.appendChild(optionFrom);

        const optionTo = document.createElement("option");
        optionTo.value = symbol;
        optionTo.textContent = symbol;
        toSelect.appendChild(optionTo);
      });

      fromSelect.value = "BTC";
      toSelect.value = "USDT";
      updateIcons();
    }

    function updateIcons() {
      const from = supportedCoins.find(c => c.symbol === fromSelect.value);
      const to = supportedCoins.find(c => c.symbol === toSelect.value);
      iconFrom.src = from ? `https://crypto-icons.pages.dev/api/icon/${from.icon}/color` : "";
      iconTo.src = to ? `https://crypto-icons.pages.dev/api/icon/${to.icon}/color` : "";
      iconFrom.alt = from ? from.symbol : "";
      iconTo.alt = to ? to.symbol : "";
      console.log("Icons updated:", iconFrom.src, iconTo.src);
    }

    async function convert() {
      const from = supportedCoins.find(c => c.symbol === fromSelect.value);
      const to = supportedCoins.find(c => c.symbol === toSelect.value);
      const amount = parseFloat(amountInput.value);

      console.log('Convert called with:', { from, to, amount });

      if (!amount || amount <= 0) {
        resultText.textContent = "Masukkan jumlah valid...";
        console.warn("Invalid amount");
        return;
      }

      if (!from || !to) {
        resultText.textContent = "Mata uang tidak didukung.";
        console.warn("Unsupported currency");
        return;
      }

      try {
        const ids = [from.id, to.id].join(",");
        const url = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`;
        console.log("Fetching from CoinGecko:", url);

        const res = await fetch(url);
        if (!res.ok) throw new Error("Gagal mengambil data harga: " + res.status);
        const data = await res.json();

        console.log("CoinGecko response:", data);

        if (!data[from.id] || !data[to.id]) {
          resultText.textContent = "Data harga tidak lengkap.";
          console.error("Missing price data for:", from.id, to.id);
          return;
        }

        const priceFromUSD = data[from.id].usd;
        const priceToUSD = data[to.id].usd;

        const converted = amount * (priceFromUSD / priceToUSD);

        resultText.textContent = `${amount} ${from.symbol} â‰ˆ ${converted.toFixed(6)} ${to.symbol}`;
        console.log("Conversion result:", resultText.textContent);
      } catch (error) {
        resultText.textContent = "Gagal mengambil data harga.";
        console.error("Fetch error:", error);
      }
    }

    populateSelects();
    convert();

    fromSelect.addEventListener("change", () => {
      updateIcons();
      convert();
    });

    toSelect.addEventListener("change", () => {
      updateIcons();
      convert();
    });

    amountInput.addEventListener("input", convert);
  </script>
</body>
</html>
