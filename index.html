// AutoCryptoConverter.tsx
import { useEffect, useState } from "react";

const symbols = ["BTC", "ETH", "SOL", "MATIC"];
const quote = "USDT";

export default function AutoCryptoConverter() {
  const [prices, setPrices] = useState<Record<string, number>>({});
  const [selectedSymbol, setSelectedSymbol] = useState("BTC");
  const [inputValue, setInputValue] = useState("");
  const [convertTo, setConvertTo] = useState<"crypto" | "usdt">("usdt");

  useEffect(() => {
    const ws = new WebSocket(
      `wss://stream.binance.com:9443/stream?streams=${symbols
        .map((s) => `${s.toLowerCase()}usdt@miniTicker`)
        .join("/")}`
    );

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      const symbol = data.data.s.replace("USDT", "");
      const price = parseFloat(data.data.c);
      setPrices((prev) => ({ ...prev, [symbol]: price }));
    };

    return () => ws.close();
  }, []);

  const price = prices[selectedSymbol] || 0;
  const isCryptoToUSDT = convertTo === "usdt";

  const result = (() => {
    const val = parseFloat(inputValue);
    if (isNaN(val)) return "";
    return isCryptoToUSDT
      ? (val * price).toFixed(2)
      : (val / price).toFixed(6);
  })();

  return (
    <div className="min-h-screen bg-gray-900 text-white flex items-center justify-center p-4">
      <div className="bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md space-y-6">
        <h1 className="text-2xl font-bold text-center">Crypto ↔ USDT Converter</h1>

        <div className="flex space-x-2">
          <select
            className="flex-1 bg-gray-700 p-2 rounded text-white"
            value={selectedSymbol}
            onChange={(e) => setSelectedSymbol(e.target.value)}
          >
            {symbols.map((sym) => (
              <option key={sym} value={sym}>
                {sym}
              </option>
            ))}
          </select>
          <button
            className="bg-blue-600 hover:bg-blue-500 rounded px-4"
            onClick={() =>
              setConvertTo(convertTo === "usdt" ? "crypto" : "usdt")
            }
          >
            ⇆
          </button>
        </div>

        <div className="space-y-2">
          <label className="block text-sm text-gray-400">
            {isCryptoToUSDT ? selectedSymbol : "USDT"} Amount
          </label>
          <input
            type="number"
            className="w-full p-2 bg-gray-700 rounded text-white"
            value={inputValue}
            onChange={(e) => setInputValue(e.target.value)}
            placeholder="0.0"
          />
        </div>

        <div className="text-center text-lg mt-4">
          = {result} {isCryptoToUSDT ? "USDT" : selectedSymbol}
        </div>

        <div className="text-sm text-gray-400 text-center">
          Live price: 1 {selectedSymbol} = {price || "..."} USDT
        </div>
      </div>
    </div>
  );
}
